name: Build OpenWRT for AX6-NSS

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/VIKINGYFY/immortalwrt.git
  REPO_BRANCH: main
  CONFIG_FILE: AX6-IPQ/.config-1g
  DIY_SH: AX6-IPQ/diy.sh
  FILES: AX6-IPQ/files
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: ç¯å¢ƒä¿¡æ¯
        run: |
          echo "è­¦å‘Šâš "
          echo "CPUä¿¡æ¯ï¼š$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c)"
          echo "å†…å­˜ï¼š$(sudo lshw -short -C memory | grep GiB)"
          echo "ç¡¬ç›˜ï¼š$(df -Th)"

      - name: æ¸…ç†ç£ç›˜
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 10240
          swap-size-mb: 1
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout
        uses: actions/checkout@main

      - name: å®‰è£…ä¾èµ–
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update -y
          sudo -E apt-get -qq install -y $(curl -fsSL https://raw.githubusercontent.com/nantayo/My-Pkg/master/2305)
          sudo -E apt-get -qq clean

      - name: å…‹éš†æºç 
        run: git clone $REPO_URL -b $REPO_BRANCH openwrt

      - name: ç¼“å­˜åŠ é€Ÿ
        uses: stupidloud/cachewrtbuild@main
        with:
          ccache: 'true'
          # ğŸš© æ¯æ¬¡è°ƒè¯•æ”¹ key å¼ºåˆ¶å¤±æ•ˆç¼“å­˜
          mixkey: AX6-NSS-${{ env.REPO_BRANCH }}-V3
          prefix: ${{ github.workspace }}/openwrt

      - name: åŠ è½½é…ç½® & è¿è¡Œ DIY
        run: |
          [ -e "$FILES" ] && mv "$FILES" openwrt/files
          [ -e "$CONFIG_FILE" ] && mv "$CONFIG_FILE" openwrt/.config
          chmod +x "$DIY_SH"
          cd openwrt
          "$GITHUB_WORKSPACE/$DIY_SH"        # å†…éƒ¨å·² feeds update/install
          make defconfig

          # >>> NSS å…³é”®é…ç½®å¼ºåˆ¶å†™å…¥ <<<
          echo "CONFIG_QCA_NSS_ECM_NSS_ENABLE=y" >> .config
          echo "# CONFIG_QCA_NSS_ECM_PPE_ENABLE is not set" >> .config
          echo "CONFIG_QCA_NSS_ECM_FRONT_END_SEL=0" >> .config
          make defconfig
          grep -q "CONFIG_QCA_NSS_ECM_NSS_ENABLE=y" .config || (echo "âŒ NSS ECM æœªç”Ÿæ•ˆ" && exit 1)

      - name: ä¸‹è½½è½¯ä»¶åŒ…
        working-directory: ./openwrt
        run: |
          make download -j8
          find dl -size -1024c -exec rm -f {} \;

      - name: ç¼–è¯‘
        working-directory: ./openwrt
        run: |
          make -j$(nproc) || make -j1 V=s
          echo "compile_status=success" >> $GITHUB_ENV

      - name: æ•´ç†å›ºä»¶
        run: |
          mkdir -p upload
          cp openwrt/bin/targets/*/*.{ubi,bin} upload/

      - name: å‘å¸ƒ Release
        uses: ncipollo/release-action@main
        with:
          tag: AX6_NSS_$(date +%Y%m%d%H%M%S)
          artifacts: upload/*
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            åŸºäº VIKINGYFY/immortalwrt æ„å»ºï¼ŒNSS æ»¡è¡€åŠ é€Ÿã€‚
            é»˜è®¤ IPï¼š192.168.1.1  è´¦å·ï¼šroot  å¯†ç ï¼šç©º

name: Build OpenWRT for AX6-NSS

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/VIKINGYFY/immortalwrt.git
  REPO_BRANCH: main
  CONFIG_FILE: AX6-IPQ/.config-1g
  DIY_SH: AX6-IPQ/diy.sh
  FILES: AX6-IPQ/files
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 环境信息
        run: |
          echo "警告⚠"
          echo "CPU信息：$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c)"
          echo "内存：$(sudo lshw -short -C memory | grep GiB)"
          echo "硬盘：$(df -Th)"

      - name: 清理磁盘
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 10240
          swap-size-mb: 1
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout
        uses: actions/checkout@main

      - name: 安装依赖
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update -y
          sudo -E apt-get -qq install -y $(curl -fsSL https://raw.githubusercontent.com/nantayo/My-Pkg/master/2305)
          sudo -E apt-get -qq clean

      - name: 克隆源码
        run: git clone $REPO_URL -b $REPO_BRANCH openwrt

      - name: 缓存加速
        uses: stupidloud/cachewrtbuild@main
        with:
          ccache: 'true'
          # 🚩 每次调试改 key 强制失效缓存
          mixkey: AX6-NSS-${{ env.REPO_BRANCH }}-V3
          prefix: ${{ github.workspace }}/openwrt

      - name: 加载配置 & 运行 DIY
        run: |
          [ -e "$FILES" ] && mv "$FILES" openwrt/files
          [ -e "$CONFIG_FILE" ] && mv "$CONFIG_FILE" openwrt/.config
          chmod +x "$DIY_SH"
          cd openwrt
          "$GITHUB_WORKSPACE/$DIY_SH"        # 内部已 feeds update/install
          make defconfig

          # >>> NSS 关键配置强制写入 <<<
          echo "CONFIG_QCA_NSS_ECM_NSS_ENABLE=y" >> .config
          echo "# CONFIG_QCA_NSS_ECM_PPE_ENABLE is not set" >> .config
          echo "CONFIG_QCA_NSS_ECM_FRONT_END_SEL=0" >> .config
          make defconfig
          grep -q "CONFIG_QCA_NSS_ECM_NSS_ENABLE=y" .config || (echo "❌ NSS ECM 未生效" && exit 1)

      - name: 下载软件包
        working-directory: ./openwrt
        run: |
          make download -j8
          find dl -size -1024c -exec rm -f {} \;

      - name: 编译
        working-directory: ./openwrt
        run: |
          make -j$(nproc) || make -j1 V=s
          echo "compile_status=success" >> $GITHUB_ENV

      - name: 整理固件
        run: |
          mkdir -p upload
          cp openwrt/bin/targets/*/*.{ubi,bin} upload/

      - name: 发布 Release
        uses: ncipollo/release-action@main
        with:
          tag: AX6_NSS_$(date +%Y%m%d%H%M%S)
          artifacts: upload/*
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            基于 VIKINGYFY/immortalwrt 构建，NSS 满血加速。
            默认 IP：192.168.1.1  账号：root  密码：空
